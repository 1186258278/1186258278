name: Sync Pinned Repos to README

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch pinned repos and update README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.repository_owner }}"

          # ç”¨ GitHub GraphQL API è·å–ç½®é¡¶ä»“åº“
          PINNED_JSON=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
            -X POST https://api.github.com/graphql \
            -d "{\"query\": \"{ user(login: \\\"$USERNAME\\\") { pinnedItems(first: 6, types: REPOSITORY) { nodes { ... on Repository { name description url stargazerCount primaryLanguage { name } } } } } }\"}")

          # è§£æ JSON ç”Ÿæˆ Markdown å¼•ç”¨å—
          TABLE=$(echo "$PINNED_JSON" | python3 -c "
          import json, sys

          data = json.load(sys.stdin)
          nodes = data['data']['user']['pinnedItems']['nodes']

          # emoji æ˜ å°„
          emoji_map = {
              'OpenClawChineseTranslation': 'ğŸ¦',
              'OpenCodeChineseTranslation': 'ğŸš€',
              'QingChenMail': 'ğŸ“§',
              'TalentLens': 'ğŸ”',
          }

          lines = []
          for repo in nodes:
              name = repo['name']
              desc = (repo['description'] or '').split('ã€‚')[0].split('. ')[0]
              if len(desc) > 60:
                  desc = desc[:57] + '...'
              url = repo['url']
              lang = repo['primaryLanguage']['name'] if repo['primaryLanguage'] else ''
              emoji = emoji_map.get(name, 'ğŸ“¦')

              display = name
              if 'ChineseTranslation' in name:
                  display = name.replace('ChineseTranslation', ' æ±‰åŒ–ç‰ˆ')
              elif name == 'QingChenMail':
                  display = 'æ™´è¾°äº‘é‚®'

              lang_tag = f' \`{lang}\`' if lang else ''
              lines.append(f'> **[{emoji} {display}]({url})** â€” {desc}{lang_tag}')
              lines.append(f'>')

          # å»æ‰æœ€åä¸€ä¸ªç©ºå¼•ç”¨è¡Œ
          if lines and lines[-1] == '>':
              lines.pop()

          print('\n'.join(lines))
          ")

          # æ›¿æ¢ README ä¸­ <!--PINNED_START--> å’Œ <!--PINNED_END--> ä¹‹é—´çš„å†…å®¹
          python3 -c "
          content = open('README.md', 'r').read()
          start_marker = '<!--PINNED_START-->'
          end_marker = '<!--PINNED_END-->'

          if start_marker in content and end_marker in content:
              before = content[:content.index(start_marker) + len(start_marker)]
              after = content[content.index(end_marker):]
              table = '''$TABLE'''
              new_content = before + '\n' + table + '\n' + after
              open('README.md', 'w').write(new_content)
              print('README updated successfully')
          else:
              print('Markers not found, skipping')
          "

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-sync pinned repos"
            git pull --rebase origin main
            git push
          fi
